{% extends "admin/change_form.html" %}

{% load i18n admin_modify  %}

{% block after_field_sets %}

{% load staticfiles %}

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>

<script language=javascript type='text/javascript'>

    // Assign IDs to vector, marker and insert fields (complete <div> with Label and help text)
    // By default, input elements themselves are accessible by, for example:
    // "id_marker" and "add_id_marker" (the Plus symbol for sub-forms). 
    function initIdDiv(){
        try{
            var scr = "";
            var divs = document.getElementsByTagName("div");
            for(var i = 0; i < divs.length; i++){
                if (divs[i].className=='field-box field-insert') {
                    divs[i].id = 'id_field_insert';
                }
                if (divs[i].className=='field-box field-marker') {
                    divs[i].id = 'id_field_marker';
                }
                if (divs[i].className=='field-box field-vectorBackbone') {
                    divs[i].id = 'id_field_vectorBackbone';
                }
                
            }    
        } catch (e) {
            log(e.message);
        }
    }

    // returns 1 if all items are sucessfully removed
    // otherwise returns zero.
    function clearListBox(listboxID){
        var box = document.getElementById(listboxID);
        if(box == null)
            return 0;
        while(box.length > 0){
            box.remove(0);
        }
        return 1;
    }
    
    function clearTypeBox(){
        return clearListBox('id_componentType')
    }
    
    // update content of Type ChoiceField depending on Category selection
    function updateListBox(selectedType){
        clearTypeBox();
        var elementId = 'id_componentType'

        $.ajax({
                        async: false,
                        type: 'GET',
                        url: "/getTypeDnaInfo/"+selectedType+"/",
                        success: function(data){
                            var p = jQuery.parseJSON(data);
                            var listbox = document.getElementById(elementId);
                            listbox.options[0] = new Option('---specifiy type---', "");
                            listbox.options[0].selected = true;
                            for (var key in p) {
                                var i = parseInt(key)
                                if (p.hasOwnProperty(key)) {
                                    listbox.options[i+1] = new Option(p[key].fields.name, p[key].pk);
                                    //if object already exists and we go back to the original
                                    //category, always select current type of object
                                    {% if original %}
                                        if ({{original.componentType.pk}} == p[key].pk)
                                            listbox.options[i+1].selected = true;
                                    {% endif %}
                                }
                            }                            
                        }
                }                
            );	
    }

    function hideShow() {
<!--        alert( document.getElementById('id_field_insert') )-->
        var categoryElement = document.getElementById('id_componentCategory');
        var category = categoryElement.options[categoryElement.selectedIndex].label
        
        updateListBox(category)

        switch ( category ) {
            case 'Vector Backbone':
                document.getElementById('id_field_insert').style.visibility = 'hidden';
                document.getElementById('id_field_vectorBackbone').style.visibility = 'hidden';
                document.getElementById('id_field_marker').style.visibility = 'visible';
                break;
            case 'Plasmid':
                document.getElementById('id_field_insert').style.visibility = 'visible';
                document.getElementById('id_field_vectorBackbone').style.visibility = 'visible';
                document.getElementById('id_field_marker').style.visibility = 'hidden';
                break;
            case 'Insert':
                document.getElementById('id_field_insert').style.visibility = 'hidden';
                document.getElementById('id_field_vectorBackbone').style.visibility = 'hidden';
                document.getElementById('id_field_marker').style.visibility = 'visible';
                break;
            case 'Marker':
                document.getElementById('id_field_insert').style.visibility = 'hidden';
                document.getElementById('id_field_vectorBackbone').style.visibility = 'hidden';
                document.getElementById('id_field_marker').style.visibility = 'hidden';
                break;
            default:
                document.getElementById('id_field_insert').style.visibility = 'hidden';
                document.getElementById('id_field_vectorBackbone').style.visibility = 'hidden';
                document.getElementById('id_field_marker').style.visibility = 'hidden';
                break;
        }
    }   
    
    // return a dictionary of Category names mapping to their position in listbox 
    function captureCategories() {
        var listbox = document.getElementById('id_componentCategory')
        var table = {};    
        for (var i=0; i < listbox.options.length; i++){
            table[ listbox.options[i].text ] = i;
        }
        return table;
    }

    //pre-select category if given in URL; requires context_processors.request
    function preselectCategory() {
        if ("{{request.GET.category}}" != ""){
            var i = parseInt("{{request.GET.category}}");
            document.getElementById('id_componentCategory').options[i].selected = true;
        }
    }
    
    // override the link for "+" Buttons so that the correct category is pre-selected    
    function setPlusLinks() {
        var categories = captureCategories();
        var cat_marker = categories['Marker'].toString();
        var cat_vector = categories['Vector Backbone'].toString();
        var cat_insert = categories['Insert'].toString();
        
        var urladd = "/rotmic/dnacomponent/add/?category="
        document.getElementById("add_id_marker").href = urladd + cat_marker;
        document.getElementById("add_id_vectorBackbone").href = urladd + cat_vector;
        document.getElementById("add_id_insert").href = urladd + cat_insert;
    }

    window.onload = function() {
        
        initIdDiv();
        setPlusLinks();
        
        preselectCategory();

        document.getElementById( 'id_componentCategory' ).onchange = hideShow;
        hideShow();
    };
    
</script>


{% endblock %}