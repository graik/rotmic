{% extends "admin/change_form.html" %}

{% load i18n admin_modify  %}

<!-- django-guardian admin modification -->
{% block object-tools-items %}
    <li><a href="permissions/" class="permissionslink">{% trans "Object permissions" %}</a></li>
    {{ block.super }}
{% endblock %}

{% if not is_popup %}
    {% block breadcrumbs%}<div class="breadcrumbs">
        {% if original %}
            <a href="../../../../">Home</a> &rsaquo;
            <a href="../../../">Rotmic</a> &rsaquo;
            <a href="../../">DNA constructs</a> &rsaquo;
            <a href="../">{{original.displayId}}</a> &rsaquo;
            Edit
        {% else %}
            <a href="../../../">Home</a> &rsaquo;
            <a href="../../">Rotmic</a> &rsaquo;
            <a href="../">DNA constructs</a> &rsaquo;
            Add DNA construct
        {% endif %}
    </div>
    {% endblock %}
{% endif %}

{% block after_field_sets %}
    
    {% block extrahead %} {{ block.super }}
        {% load selectable_tags %}
        {% include_ui_theme %}
        {% include_jquery_libs %}
    {% endblock %}
    
    <!--Now Imported by statement in DnaComponentAdmin.Media class-->
    <!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.1/jquery.min.js"></script>-->
    
    <script language=javascript type='text/javascript'>
    
     
        // Assign IDs to vector, marker and insert fields (complete <div> with Label and help text)
        // By default, input elements themselves are accessible by, for example:
        // "id_marker" and "add_id_marker" (the Plus symbol for sub-forms). 
        function initIdDiv(){
            try{
                var scr = "";
                var divs = document.getElementsByTagName("div");
                for(var i = 0; i < divs.length; i++){
                    if (divs[i].className=='field-box field-insert') {
                        divs[i].id = 'id_field_insert';
                    }
                    if (divs[i].className=='field-box field-marker') {
                        divs[i].id = 'id_field_marker';
                    }
                    if (divs[i].className=='field-box field-vectorBackbone') {
                        divs[i].id = 'id_field_vectorBackbone';
                    }
                    
                }    
            } catch (e) {
                log(e.message);
            }
        }
    
        // get (name of) currently selected Category
        function getCurrentCategory(){
            var categoryElement = document.getElementById('id_componentCategory');
            var category = categoryElement.options[categoryElement.selectedIndex].label
            return category
        }
        
        // returns 1 if all items are sucessfully removed
        // otherwise returns zero.
        function clearTypeBox(){
            var box = document.getElementById('id_componentType');
            if(box == null)
                return 0;        
            while(box.length > 0){
                box.remove(0);
            }
            return 1;
        }
        
        // update content of Type ChoiceField depending on Category selection
        // this could propably be replaced by a django template fill-in
        function updateListBox(selectedCategory){
            clearTypeBox();
            var elementId = 'id_componentType'
            var cachedTypeIndex = lastTypeSelection(selectedCategory);
    
            $.ajax({
                    async: false,
                    type: 'GET',
                    url: "/getTypeDnaInfo/"+selectedCategory+"/",
                    success: function(data){
                        var p = django.jQuery.parseJSON(data);
                        var listbox = document.getElementById(elementId);
                        listbox.options[0] = new Option('---specifiy type---', "");
                        listbox.options[0].selected = true;
                        for (var key in p) {
                            var i = parseInt(key)
                            if (p.hasOwnProperty(key)) {
                                listbox.options[i+1] = new Option(p[key].fields.name, p[key].pk);
                                //... but select previously assigned dc.componentType if object already exists with this category
                                {% if original %}
                                    if (({{original.componentType.pk}} == p[key].pk)){
                                        listbox.options[i+1].selected = true;
                                        cachedTypeIndex = 0;  // reset to prevent selection of type from previous form
                                    }
                                {% endif %}
                                // go back to previously selected type for this category
                                if ( cachedTypeIndex == i+1 ){
                                    listbox.options[i+1].selected = true;
                                }
                            }
                        }                            
                    }
                }                
            );	
        }
    
        function hideShow() {
    <!--        alert( document.getElementById('id_field_insert') )-->
            var category = getCurrentCategory();
            
            updateListBox(category)
    
            switch ( category ) {
                case 'Vector Backbone':
                    document.getElementById('id_field_insert').style.visibility = 'hidden';
                    document.getElementById('id_field_vectorBackbone').style.visibility = 'hidden';
                    document.getElementById('id_field_marker').style.visibility = 'visible';
                    break;
                case 'Plasmid':
                    document.getElementById('id_field_insert').style.visibility = 'visible';
                    document.getElementById('id_field_vectorBackbone').style.visibility = 'visible';
                    document.getElementById('id_field_marker').style.visibility = 'hidden';
                    break;
                case 'Fragment':
                    document.getElementById('id_field_insert').style.visibility = 'hidden';
                    document.getElementById('id_field_vectorBackbone').style.visibility = 'hidden';
                    document.getElementById('id_field_marker').style.visibility = 'visible';
                    break;
                case 'Marker':
                    document.getElementById('id_field_insert').style.visibility = 'hidden';
                    document.getElementById('id_field_vectorBackbone').style.visibility = 'hidden';
                    document.getElementById('id_field_marker').style.visibility = 'hidden';
                    break;
                default:
                    document.getElementById('id_field_insert').style.visibility = 'hidden';
                    document.getElementById('id_field_vectorBackbone').style.visibility = 'hidden';
                    document.getElementById('id_field_marker').style.visibility = 'hidden';
                    break;
            }
        }   
        
        // return a dictionary of Category names mapping to their position in listbox 
        function captureCategories() {
            var listbox = document.getElementById('id_componentCategory')
            var table = {};
            for (var i=0; i < listbox.options.length; i++){
                table[ listbox.options[i].text ] = i;
            }
            return table;
        }
    
        // cache last position in componentType listbox for each category selection
        // Memorize the last selected componentType so that it can be re-instantiated
        // after the listbox is wiped
        // see: https://developer.mozilla.org/en-US/docs/Web/Guide/DOM/Storage?redirectlocale=en-US&redirectslug=DOM%2FStorage
        function cacheTypeSelection() {
            var category = getCurrentCategory();
            sessionStorage.setItem( category, document.getElementById( 'id_componentType' ).selectedIndex);
        }
        
        function lastTypeSelection(category) {
            var r = sessionStorage.getItem( category );
            if (! r){ return 0; }
            return r; 
        }
    
        //pre-select category if given in URL; requires context_processors.request
        //requires context_processors.request in settings.py
        function preselectCategory() {
            if ("{{request.GET.category}}" != ""){
                var i = parseInt("{{request.GET.category}}");
                document.getElementById('id_componentCategory').options[i].selected = true;
            }
        }
        
        // override the link for "+" Buttons so that the correct category is pre-selected    
        function setPlusLinks() {
            var categories = captureCategories();
            var cat_marker = categories['Marker'].toString();
            var cat_vector = categories['Vector Backbone'].toString();
            var cat_insert = categories['Fragment'].toString();
            
            var urladd = "/rotmic/dnacomponent/add/?category="
            document.getElementById("add_id_marker").href = urladd + cat_marker;
            document.getElementById("add_id_vectorBackbone").href = urladd + cat_vector;
            document.getElementById("add_id_insert").href = urladd + cat_insert;
        }
    
        function resetStorageBetweenForms() {
            {% if original %} var objectId = {{original.pk}}; {% else %} var objectId = -1; {% endif %}
            if (sessionStorage.getItem( 'DnaComponent_lastvisited' )){
                if (sessionStorage.getItem( 'DnaComponent_lastvisited' ) != objectId){
                    if (objectId != -1){
                        sessionStorage.clear();
                        // Note: insert more specific code here to only delete entry for each category name
                    }
                }
            }
            sessionStorage.setItem( 'DnaComponent_lastvisited', objectId );
        }
    
        // "Main" function
        window.onload = function() {
            
            resetStorageBetweenForms();
            initIdDiv();
            setPlusLinks();
            
            preselectCategory();
            
            document.getElementById( 'id_componentCategory' ).onchange = hideShow;
            document.getElementById( 'id_componentType' ).onchange = cacheTypeSelection;
            hideShow();
        };
        
    </script>

{% endblock %}